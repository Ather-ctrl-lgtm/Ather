DECLARE
  rollno Borrower.Roll_no%TYPE := &rollno;
  book Borrower.Name_of_Book%TYPE := '&bookname';
  dateissue Borrower.Date_of_Issue%TYPE;
  days NUMBER;
  fine NUMBER := 0;
  e_no_borrow EXCEPTION; -- user-defined exception
BEGIN
  -- Get Date_of_Issue for given Roll_no and Book
  SELECT Date_of_Issue
  INTO dateissue
  FROM Borrower
  WHERE Roll_no = rollno 
    AND Name_of_Book = book 
    AND Status = 'I';

  -- Calculate number of days book kept
  days := TRUNC(SYSDATE - dateissue);

  -- Fine calculation
  IF days <= 14 THEN
    fine := 0;
  ELSIF days BETWEEN 15 AND 30 THEN
    fine := days * 5;
  ELSE
    fine := days * 50;
  END IF;

  -- Update Borrower status to Returned
  UPDATE Borrower
  SET Status = 'R'
  WHERE Roll_no = rollno 
    AND Name_of_Book = book;

  -- If fine > 0 then insert into Fine table
  IF fine > 0 THEN
    INSERT INTO Fine (Roll_no, Date, Amt)
    VALUES (rollno, SYSDATE, fine);
    DBMS_OUTPUT.PUT_LINE('Fine imposed: Rs ' || fine);
  ELSE
    DBMS_OUTPUT.PUT_LINE('No Fine. Book returned on time.');
  END IF;

  COMMIT;

EXCEPTION
  WHEN NO_DATA_FOUND THEN
    DBMS_OUTPUT.PUT_LINE('Error: No record found for Roll No ' || rollno || ' and Book ' || book);
  WHEN TOO_MANY_ROWS THEN
    DBMS_OUTPUT.PUT_LINE('Error: Duplicate records found. Please check Borrower table.');
  WHEN e_no_borrow THEN
    DBMS_OUTPUT.PUT_LINE('Error: Borrower details not found.');
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Unexpected error: ' || SQLERRM);
END;
/
